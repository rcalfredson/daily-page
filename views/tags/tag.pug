extends ../layout

include ../partials/_read_more
include ../partials/_translation_attribution

block nav
  include ../navLinks

block append head
  link(rel='stylesheet' href='/css/blocks-dashboard.css')
  link(rel='stylesheet' href='/css/pagination.css')
  link(rel='stylesheet' href='/css/tags.css')
  link(rel="stylesheet" href="/css/vote-controls.css")
  link(rel='stylesheet' href='/css/toast.css')
  link(rel="stylesheet" href="/css/modal.css")
  link(rel='stylesheet' href='/css/translation-attribution.css')
  script(src='https://cdn.jsdelivr.net/npm/chart.js')

block append scripts
  script(src='/js/toast-utils.js')
  script(src="/js/vote-controls.js")
  script(src='/js/modal.js')

block content
  .tag-header
    h1 #{t('tags.detail.header.icon')} #{t('tags.detail.header.label')} #[span.tag-name #{tagName}]
    p.tag-stats
      | #{t('tags.detail.stats.totalBlocks')} 
      strong #{tagName}
      | #{t('tags.detail.stats.totalBlocksTagSeparator')} 
      strong #{totalBlocks}

  // Trend chart container
  if trendData.length >= 2
    .chart-container
      canvas#tagTrendChart

  if taggedBlocks.length
    ul.block-list
      each block in taggedBlocks
        li.block-preview(lang=(block.lang || 'en'))
          .content
            a.block-title(href=`/rooms/${block.roomId}/blocks/${block._id}` lang=(block.lang || 'en'))= block.title
            p(lang=(uiLang || 'en'))
              | #{t('tags.detail.blockInfo.createdBy')} 
              a.user-profile-link(href=uiPath(`/users/${block.creator}`))= block.creator
              |  #{t('tags.detail.blockInfo.inRoom')} 
              a.room-link(href=uiPath(`/rooms/${block.roomId}`))= block.roomDisplayName || block.roomId || t('tags.detail.blockInfo.unknownRoom')
              |  #{t('tags.detail.blockInfo.onDate')} 
              = new Date(block.createdAt).toLocaleString(uiLang || undefined, { dateStyle: 'medium', timeStyle: 'short' })
            +translationAttribution(block)
            div(class=['content-preview', {'fade-footer': block.truncated}], lang=(block.lang || 'en'))!= block.contentHTML
          +readMoreIfTruncated(block, block.roomId)
          footer.block-footer
            include ../partials/_vote_controls

  else
    p= t('tags.detail.empty.message')

  - const baseUrl = uiPath(`/tags/${encodeURIComponent(tagName)}`);
  include ../partials/_pagination
  +pagination(currentPage, totalPages, baseUrl)
  include ../partials/_login_modal
  #toast-container

  script.
    (function () {
      // Inyecta los datos del servidor a una constante con nombre distinto
      const __trendData = !{JSON.stringify(trendData)};

      if (!Array.isArray(__trendData) || __trendData.length <= 1) {
        return;
      }

      const canvas = document.getElementById('tagTrendChart');
      if (!canvas) return;
      const ctxTrend = canvas.getContext('2d');

      const labels = __trendData.map(e => e._id);
      const dataCounts = __trendData.map(e => e.count);

      new Chart(ctxTrend, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '#{t("tags.detail.chart.label")}',
            data: dataCounts,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true },
            x: {
              ticks: { maxRotation: 45, minRotation: 45, autoSkip: false }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    })();
