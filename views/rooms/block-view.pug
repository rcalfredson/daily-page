extends ../layout

block nav
  include ../navLinks

block append head
  -
    // Helpers
    const base   = process.env.BASE_URL || 'https://dailypage.org';
    const makeUrl = id => `${base}/rooms/${room_id}/blocks/${id}`;
  link(rel='canonical' href=makeUrl(block._id))
  each t in translations
    if t.lang !== lang
      link(rel='alternate' hreflang=t.lang href=`${base}/rooms/${room_id}/blocks/${t._id}`)
  // fallback for ‚Äúany/unknown‚Äù language
  link(rel='alternate' hreflang='x-default' href=makeUrl(block._id))
  link(rel='stylesheet' href='/css/block-view.css')
  link(rel='stylesheet' href='/css/block-tags.css')
  link(rel='stylesheet' href='/css/delete-block.css')
  link(rel='stylesheet' href='/css/vote-controls.css')
  link(rel='stylesheet' href='/css/toast.css')
  link(rel='stylesheet' href='/css/modal.css')
  link(rel='stylesheet' href='/css/flag-modal.css')
  link(rel='stylesheet' href='/css/lang-switcher.css')
  link(rel='stylesheet' href='/css/table-scroll-fade.css')

block append scripts
  include ../envImport
  // Vote controls script if you have voting on the viewer
  script(src='/js/toast-utils.js')
  script(src='/js/action-wrap-detect.js')
  script(src='/js/vote-controls.js')
  script(src='/js/modal.js')
  script(src='/js/flag-block.js')
  script(src="/js/view-block-description.js")
  script(src="/js/share-block.js")
  script(src='/js/table-scroll-fade.js')

block content
  - const flagEmoji = { en:'üá∫üá∏', es:'üá™üá∏', fr:'üá´üá∑', ru:'üá∑üá∫', id:'üáÆüá©', de:'üá©üá™', it:'üáÆüáπ', pt:'üáµüáπ', zh:'üá®üá≥', ja:'üáØüáµ', ko:'üá∞üá∑', ar:'üá∏üá¶', hi:'üáÆüá≥', tr:'üáπüá∑', nl:'üá≥üá±', sv:'üá∏üá™', no:'üá≥üá¥', da:'üá©üá∞', fi:'üá´üáÆ', pl:'üáµüá±', cs:'üá®üáø', el:'üá¨üá∑', he:'üáÆüá±', th:'üáπüá≠', vi:'üáªüá≥' };
  include ../partials/_tag_section
  #block-page
    .block-header
      .header-top(style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;")
        .room-info
          | #{t('blockView.labels.room')}
          a.room-link(href=`/rooms/${room_id}`)= roomName

        // only show when multiple translations exist
        if translations.length > 1
          details.lang-switcher
            summary
              span #{t('blockView.labels.lang')}
              span.current-lang.pill
                span.flag= flagEmoji[lang] || 'üè≥Ô∏è'
                | #{lang}
            ul.lang-list
              - const uiQS = uiLang ? `&ui=${uiLang}` : '';
              each tr in translations
                if tr.lang !== lang
                  li
                    a.pill(href=`/rooms/${room_id}/blocks/${tr._id}?lang=${tr.lang}${uiQS}`)
                      span.flag= flagEmoji[tr.lang] || 'üè≥Ô∏è'
                      | #{tr.lang}
      .title-section
        .vote-section
          include ../partials/_vote_controls
        h1.block-title= block.title
        // Only show edit link if the block is in-progress
        .interact-section
          .action-buttons
            if block.status === 'in-progress'
              a.block-edit-btn(href=`/rooms/${room_id}/blocks/${block._id}/edit`)= t('blockView.buttons.edit')
            if canManageBlock
              button#delete-block-btn.delete-btn(
                data-block-id=block._id
              )= t('blockView.buttons.deleteBlock')
            button#share-btn.share-btn #{t('blockView.buttons.share')} ‚ú®
            button#flag-block-btn
              i.fa.fa-flag(aria-hidden="true")
              | #{t('blockView.buttons.flagContent')}

    // Description block, read-only style
    .block-description-card
      span.description-label= t('blockView.description.label')
      .description-body.collapsed
        - const noDesc = `<p><em>${t('blockView.description.none')}</em></p>`;
        div#description-view!= descriptionHTML || noDesc
      .expand-toggle
        span= t('blockView.description.expand')

    // The main content, already rendered to HTML on the server
    .block-content
      != block.contentHTML
    hr
    +tagSection(block.tags, false)

  // Reuse your login modal partial if needed
  include ../partials/_login_modal
  include ../partials/_block_delete_confirm
  include ../partials/_flag_modal
  #toast-container
  div#share-modal.share-modal.hidden
    div.share-modal-content
      span.share-close-btn &times;
      h2= t('blockView.share.title')
      p= t('blockView.share.shareOn')
      ul.share-links
        li
          a(href="#" id="share-facebook" target="_blank")
            img.share-icon(src="https://cdn.simpleicons.org/facebook/1877F2" alt=t('blockView.share.alt.facebook'))
            | Facebook
        li
          a(href="#" id="share-reddit" target="_blank")
            img.share-icon(src="https://cdn.simpleicons.org/reddit/FF4500" alt=t('blockView.share.alt.reddit'))
            | Reddit
        li
          a(href="#" id="share-whatsapp" target="_blank")
            img.share-icon(src="https://cdn.simpleicons.org/whatsapp/25D366" alt=t('blockView.share.alt.whatsapp'))
            | WhatsApp
        li
          a(href="#" id="share-twitter" target="_blank")
            img.share-icon(src="https://cdn.simpleicons.org/x/000000" alt=t('blockView.share.alt.twitter'))
            | Twitter
